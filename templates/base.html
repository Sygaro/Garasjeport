
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <title>Garasjeport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/styles.css" rel="stylesheet">

  <style>
    .fade-out {
      opacity: 0;
      transition: opacity 0.8s ease-out;
    }
    .progress {
      height: 4px;
      background-color: transparent;
      margin-top: 0.5rem;
    }
    .progress-bar {
      background-color: rgba(0, 0, 0, 0.3);
      width: 100%;
      transition: width 1s linear;
    }
  </style>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".alert[data-timeout]").forEach(function (el) {
      const timeout = parseInt(el.getAttribute("data-timeout"), 10);
      const bar = el.querySelector(".progress-bar");
      let remaining = timeout;
      let interval = setInterval(() => {
        remaining--;
        bar.style.width = (remaining / timeout * 100) + "%";
        if (remaining <= 0) {
          clearInterval(interval);
          el.classList.add("fade-out");
          setTimeout(() => el.remove(), 1000);
        }
      }, 1000);
    });

    const toggleBtn = document.getElementById("themeToggle");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
      });
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }
    }
  });
  </script>
</head>
<body class="bg-body text-body" style="padding-top: 60px">
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark px-3">
  <a class="navbar-brand" href="/">Garasjeport</a>
  {% if session.get("logged_in") %}
  <ul class="navbar-nav me-auto">
    <li class="nav-item"><a class="nav-link" href="/admin/stats">Status</a></li>
    <li class="nav-item"><a class="nav-link" href="/admin/ports">Porter</a></li>
    <li class="nav-item"><a class="nav-link" href="/admin/settings">System</a></li>
    <li class="nav-item"><a class="nav-link" href="/admin/backup">Backup</a></li>
    <li class="nav-item"><a class="nav-link" href="/admin/log">Portlogg</a></li>
    <li class="nav-item"><a class="nav-link" href="/logs">Systemlogg</a></li>
    <li class="nav-item"><a class="nav-link" href="/help">Hjelp</a></li>
  </ul>
  <form class="d-flex" action="/logout" method="POST">
    <button class="btn btn-sm btn-outline-light">Logg ut</button>
  </form>
  {% endif %}
  <button id="themeToggle" class="btn btn-sm btn-outline-light ms-3">ðŸŒ“</button>
</nav>

<main class="container py-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% set timeouts = config.get("flash_timeout", {}) %}
      {% for category, message in messages %}
        {% set timeout = timeouts.get(category, 30) %}
        <div class="alert alert-{{ category }} alert-dismissible fade show"
             role="alert"
             data-timeout="{{ timeout }}">
          {{ message }}
          <div class="progress"><div class="progress-bar"></div></div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
const socket = io();
socket.on("status_update", function(data) {
  const badge = document.querySelector(`#status-${data.port}`);
  if (badge) {
    badge.textContent = data.status;
    badge.className = 'badge';
    if (data.status === "Ã¥pen") badge.classList.add("bg-success");
    else if (data.status === "lukket") badge.classList.add("bg-secondary");
    else if (data.status === "sensorfeil") badge.classList.add("bg-danger");
    else badge.classList.add("bg-warning", "text-dark");
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% block scripts %}{% endblock %}
</body>
</html>

{% extends 'base.html' %}
{% block content %}
<h2>📜 Logg for garasjeporter</h2>
<p>Filtrer hendelser etter type, port eller datoperiode. Klikk 🔍 for detaljer.</p>

<div class="row mb-3">
  <div class="col-md-3">
    <label for="filterType" class="form-label">Type</label>
    <select id="filterType" class="form-select form-select-sm">
      <option value="">Alle</option>
      {% for t in events | map(attribute='type') | unique %}
      <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label for="filterPort" class="form-label">Port</label>
    <select id="filterPort" class="form-select form-select-sm">
      <option value="">Alle</option>
      {% for p in events | map(attribute='port') | unique %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label for="filterDateFrom" class="form-label">Fra dato</label>
    <input type="date" id="filterDateFrom" class="form-control form-control-sm" />
  </div>
  <div class="col-md-3">
    <label for="filterDateTo" class="form-label">Til dato</label>
    <input type="date" id="filterDateTo" class="form-control form-control-sm" />
  </div>
</div>

<div class="mb-3 d-flex gap-2">
  <button class="btn btn-secondary btn-sm" onclick="resetFilters()">🔄 Nullstill filtre</button>
  <button class="btn btn-success btn-sm" onclick="exportCSV()">⬇️ Eksporter CSV</button>
  <span class="ms-auto text-muted mt-1" id="matchCount"></span>
</div>

<div class="table-responsive">
  <table id="logTable" class="table table-sm table-hover table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th>🕒</th>
        <th>📅</th>
        <th>Type</th>
        <th>Port</th>
        <th>Melding</th>
        <th>Detaljer</th>
      </tr>
    </thead>
    <tbody>
    {% for e in events %}
      {% set dt = e.time or e.timestamp %}
      {% set norsk_dato = dt[:10].split('-') if dt else ['','',''] %}
      {% set json_entry = e | tojson | default('{}') %}
      <tr 
        data-date="{{ dt[:10] if dt else '' }}" 
        data-type="{{ e.type or '' }}" 
        data-port="{{ e.port or '' }}" 
        data-entry='{{ json_entry | safe }}'
        class="{% if e.type == 'error' %}table-danger{% endif %}">
        <td class="text-nowrap">{{ dt[11:19] if dt else "-" }}</td>
        <td class="text-nowrap">{{ norsk_dato[2] }}.{{ norsk_dato[1] }}.{{ norsk_dato[0] }}</td>
        <td>{{ e.type }}</td>
        <td>
          <span class="badge 
            {% if e.port == 'port1' %}bg-primary text-white
            {% elif e.port == 'port2' %}bg-warning text-dark
            {% else %}bg-light text-dark
            {% endif %}">{{ e.port or "-" }}</span>
        </td>
        <td>{{ e.message or "-" }}</td>
        <td>
          <button class="btn btn-outline-info btn-sm" onclick="showDetails(this)">🔍</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<a href="{{ url_for('admin') }}" class="btn btn-secondary btn-sm mt-3">🔙 Tilbake til admin</a>

<!-- Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">📋 Detaljert hendelse</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="modalContent" class="bg-light p-3 rounded border small" style="white-space:pre-wrap;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Lukk</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const typeFilter = document.getElementById('filterType');
  const portFilter = document.getElementById('filterPort');
  const dateFromFilter = document.getElementById('filterDateFrom');
  const dateToFilter = document.getElementById('filterDateTo');
  const matchCount = document.getElementById('matchCount');
  const modalContent = document.getElementById('modalContent');
  const modal = new bootstrap.Modal(document.getElementById('logModal'));

  function applyFilter() {
    const type = typeFilter.value;
    const port = portFilter.value;
    const dateFrom = dateFromFilter.value;
    const dateTo = dateToFilter.value;
    const rows = document.querySelectorAll('#logTable tbody tr');

    let visibleCount = 0;

    rows.forEach(row => {
      const rowType = row.getAttribute('data-type');
      const rowPort = row.getAttribute('data-port');
      const rowDate = row.getAttribute('data-date');

      const matchesType = !type || rowType === type;
      const matchesPort = !port || rowPort === port;
      const matchesDateFrom = !dateFrom || (rowDate && rowDate >= dateFrom);
      const matchesDateTo = !dateTo || (rowDate && rowDate <= dateTo);

      const visible = matchesType && matchesPort && matchesDateFrom && matchesDateTo;
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    matchCount.textContent = `${visibleCount} treff`;
  }

  function resetFilters() {
    typeFilter.value = "";
    portFilter.value = "";
    dateFromFilter.value = "";
    dateToFilter.value = "";
    applyFilter();
  }

  function exportCSV() {
    const headers = Array.from(document.querySelectorAll("#logTable thead th")).map(h => h.textContent.trim());
    const visibleRows = Array.from(document.querySelectorAll("#logTable tbody tr")).filter(row => row.style.display !== 'none');
    const csv = [headers.join(";")];

    visibleRows.forEach(row => {
      const cols = Array.from(row.children).map(td => `"${td.textContent.trim().replace(/\n/g, ' ')}"`);
      csv.push(cols.join(";"));
    });

    const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'logg.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function showDetails(button) {
    const row = button.closest('tr');
    const raw = row.getAttribute('data-entry');
    try {
      const obj = JSON.parse(raw);
      modalContent.textContent = JSON.stringify(obj, null, 2);
    } catch (e) {
      modalContent.textContent = "Kunne ikke vise detaljer.";
    }
    modal.show();
  }

  document.addEventListener("DOMContentLoaded", () => {
    applyFilter();
    [typeFilter, portFilter, dateFromFilter, dateToFilter].forEach(el =>
      el.addEventListener('change', applyFilter)
    );
  });
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h2>Rediger systemkonfigurasjon</h2>
  <form id="configForm">
    <div class="mb-3">
      <label for="pollingInterval" class="form-label">Polling-intervall (ms)</label>
      <input type="number" class="form-control" id="pollingInterval" name="polling_interval_ms">
    </div>

    <h4>Relé-pinner</h4>
    <div class="row">
      <div class="col">
        <label for="relay1" class="form-label">Port 1</label>
        <input type="number" class="form-control" id="relay1" name="relay_port1">
      </div>
      <div class="col">
        <label for="relay2" class="form-label">Port 2</label>
        <input type="number" class="form-control" id="relay2" name="relay_port2">
      </div>
    </div>

    <h4 class="mt-4">Sensorpinner</h4>
    <div class="row">
      <div class="col">
        <label>Port 1 – Åpen</label>
        <input type="number" class="form-control" id="sensor1_open">
      </div>
      <div class="col">
        <label>Port 1 – Lukket</label>
        <input type="number" class="form-control" id="sensor1_closed">
      </div>
    </div>
    <div class="row mt-2">
      <div class="col">
        <label>Port 2 – Åpen</label>
        <input type="number" class="form-control" id="sensor2_open">
      </div>
      <div class="col">
        <label>Port 2 – Lukket</label>
        <input type="number" class="form-control" id="sensor2_closed">
      </div>
    </div>
    <div class="mb-3">
  <label for="logRotationDays" class="form-label">Roter loggfiler etter (dager)</label>
  <input type="number" class="form-control" id="logRotationDays">
</div>

<div class="mb-3">
  <label for="logRetentionDays" class="form-label">Behold arkiverte logger i (dager)</label>
  <input type="number" class="form-control" id="logRetentionDays">
</div>


    <button type="submit" class="btn btn-primary mt-4">Lagre endringer</button>
    <div id="saveStatus" class="mt-3 text-success" style="display: none;">Endringer lagret!</div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch('/api/config')
    .then(res => res.json())
    .then(config => {
      document.getElementById("logRotationDays").value = config.log_rotation_days || 7;
      document.getElementById("logRetentionDays").value = config.log_archive_retention_days || 30;
      document.getElementById("pollingInterval").value = config.polling_interval_ms || 100;
      document.getElementById("relay1").value = config.relay_pins.port1;
      document.getElementById("relay2").value = config.relay_pins.port2;
      document.getElementById("sensor1_open").value = config.sensor_pins.port1.open;
      document.getElementById("sensor1_closed").value = config.sensor_pins.port1.closed;
      document.getElementById("sensor2_open").value = config.sensor_pins.port2.open;
      document.getElementById("sensor2_closed").value = config.sensor_pins.port2.closed;
    });

  document.getElementById("configForm").addEventListener("submit", async e => {
    e.preventDefault();

    const updatedConfig = {
      polling_interval_ms: parseInt(document.getElementById("pollingInterval").value),
      relay_pins: {
        port1: parseInt(document.getElementById("relay1").value),
        port2: parseInt(document.getElementById("relay2").value)
      },
      sensor_pins: {
        port1: {
          open: parseInt(document.getElementById("sensor1_open").value),
          closed: parseInt(document.getElementById("sensor1_closed").value)
        },
        port2: {
          open: parseInt(document.getElementById("sensor2_open").value),
          closed: parseInt(document.getElementById("sensor2_closed").value)
        }  
      }
      log_rotation_days: parseInt(document.getElementById("logRotationDays").value),
      log_archive_retention_days: parseInt(document.getElementById("logRetentionDays").value),

    };

    const response = await fetch('/api/config', {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedConfig)
    });

    if (response.ok) {
      document.getElementById("saveStatus").style.display = "block";
      setTimeout(() => document.getElementById("saveStatus").style.display = "none", 3000);
    }
  });
});
</script>
{% endblock %}

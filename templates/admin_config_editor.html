{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h2>Rediger systemkonfigurasjon</h2>
  <form id="configForm">
    <div class="mb-3">
      <label for="pollingInterval" class="form-label">Polling-intervall (ms)</label>
      <input type="number" class="form-control" id="pollingInterval" required min="10">
    </div>

    <h4>Relé-pinner</h4>
    <div class="row">
      <div class="col">
        <label class="form-label">Port 1</label>
        <input type="number" class="form-control" id="relay1" required>
      </div>
      <div class="col">
        <label class="form-label">Port 2</label>
        <input type="number" class="form-control" id="relay2" required>
      </div>
    </div>

    <h4 class="mt-4">Sensorpinner</h4>
    <div class="row">
      <div class="col">
        <label>Port 1 – Åpen</label>
        <input type="number" class="form-control" id="sensor1_open" required>
      </div>
      <div class="col">
        <label>Port 1 – Lukket</label>
        <input type="number" class="form-control" id="sensor1_closed" required>
      </div>
    </div>
    <div class="row mt-2">
      <div class="col">
        <label>Port 2 – Åpen</label>
        <input type="number" class="form-control" id="sensor2_open" required>
      </div>
      <div class="col">
        <label>Port 2 – Lukket</label>
        <input type="number" class="form-control" id="sensor2_closed" required>
      </div>
    </div>

    <div class="mb-3 mt-4">
      <label for="logRotationDays" class="form-label">Roter loggfiler etter (dager)</label>
      <input type="number" class="form-control" id="logRotationDays" min="1" required>
    </div>

    <div class="mb-3">
      <label for="logRetentionDays" class="form-label">Behold arkiverte logger i (dager)</label>
      <input type="number" class="form-control" id="logRetentionDays" min="1" required>
    </div>

    <button type="submit" class="btn btn-primary mt-2">Lagre endringer</button>
  </form>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">Konfigurasjon lagret!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">Kunne ikke lagre konfigurasjon.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch('/api/config')
    .then(res => res.json())
    .then(config => {
      document.getElementById("pollingInterval").value = config.polling_interval_ms || 100;
      document.getElementById("relay1").value = config.relay_pins.port1;
      document.getElementById("relay2").value = config.relay_pins.port2;
      document.getElementById("sensor1_open").value = config.sensor_pins.port1.open;
      document.getElementById("sensor1_closed").value = config.sensor_pins.port1.closed;
      document.getElementById("sensor2_open").value = config.sensor_pins.port2.open;
      document.getElementById("sensor2_closed").value = config.sensor_pins.port2.closed;
      document.getElementById("logRotationDays").value = config.log_rotation_days || 7;
      document.getElementById("logRetentionDays").value = config.log_archive_retention_days || 30;
    });

  document.getElementById("configForm").addEventListener("submit", async e => {
    e.preventDefault();

    const updatedConfig = {
      polling_interval_ms: parseInt(document.getElementById("pollingInterval").value),
      relay_pins: {
        port1: parseInt(document.getElementById("relay1").value),
        port2: parseInt(document.getElementById("relay2").value)
      },
      sensor_pins: {
        port1: {
          open: parseInt(document.getElementById("sensor1_open").value),
          closed: parseInt(document.getElementById("sensor1_closed").value)
        },
        port2: {
          open: parseInt(document.getElementById("sensor2_open").value),
          closed: parseInt(document.getElementById("sensor2_closed").value)
        }
      },
      calibration: {},  // behold eksisterende eller legg til ny
      log_rotation_days: parseInt(document.getElementById("logRotationDays").value),
      log_archive_retention_days: parseInt(document.getElementById("logRetentionDays").value)
    };

    try {
      const response = await fetch('/api/config', {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedConfig)
      });

      if (response.ok) {
        const json = await response.json();
        document.querySelector("#toastSuccess .toast-body").textContent = json.message;
        new bootstrap.Toast(document.getElementById("toastSuccess")).show();
      } else {
        throw new Error("Lagring feilet");
      }
    } catch {
      new bootstrap.Toast(document.getElementById("toastError")).show();
    }
  });
});
</script>
{% endblock %}

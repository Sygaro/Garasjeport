
{% extends "base.html" %}
{% block content %}

<h2>üîå Portkonfigurasjon</h2>
<div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
  {% for port in config.relay_pins %}
  <div class="col">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-dark text-white">
        <strong>{{ port|capitalize }}</strong>
      </div>
      <div class="card-body">
        <form method="POST" action="/admin/ports">
          <input type="hidden" name="port" value="{{ port }}">

          <div class="mb-2">
            <label class="form-label">Rel√©</label>
            <select name="relay_bcm" class="form-select form-select-sm">
              {% for gpio in available_gpio %}
              <option value="{{ gpio.bcm }}"
                {% if gpio.bcm == config.relay_pins[port] %}selected{% endif %}
                {% if gpio.bcm in used_pins and gpio.bcm != config.relay_pins[port] %}disabled{% endif %}>
                GPIO{{ gpio.bcm }} (Pin {{ gpio.pin }})
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">√Öpen-sensor</label>
            <select name="sensor_open_bcm" class="form-select form-select-sm">
              {% for gpio in available_gpio %}
              <option value="{{ gpio.bcm }}"
                {% if gpio.bcm == config.sensor_pins[port].open %}selected{% endif %}
                {% if gpio.bcm in used_pins and gpio.bcm != config.sensor_pins[port].open %}disabled{% endif %}>
                GPIO{{ gpio.bcm }} (Pin {{ gpio.pin }})
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Lukket-sensor</label>
            <select name="sensor_closed_bcm" class="form-select form-select-sm">
              {% for gpio in available_gpio %}
              <option value="{{ gpio.bcm }}"
                {% if gpio.bcm == config.sensor_pins[port].closed %}selected{% endif %}
                {% if gpio.bcm in used_pins and gpio.bcm != config.sensor_pins[port].closed %}disabled{% endif %}>
                GPIO{{ gpio.bcm }} (Pin {{ gpio.pin }})
              </option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-primary btn-sm">üíæ Lagre GPIO-konfig</button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<hr>

<h4>‚è±Ô∏è Kalibrering</h4>
<div class="row row-cols-1 row-cols-md-2 g-4">
  {% for port in config.relay_pins %}
  <div class="col">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-secondary text-white">
        <strong>{{ port|capitalize }}</strong> kalibrering
      </div>
      <div class="card-body">
        {% set cal = config.get("calibration", {}).get(port, {}) %}
        <form method="POST" action="/admin/calibrate">
          <input type="hidden" name="port" value="{{ port }}">

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">√Öpnetid (sek)</span>
            <input type="number" step="0.1" min="0" max="60" name="open_time" class="form-control"
                   value="{{ cal.get('open_time', '') }}">
          </div>

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">Lukketid (sek)</span>
            <input type="number" step="0.1" min="0" max="60" name="close_time" class="form-control"
                   value="{{ cal.get('close_time', '') }}">
          </div>

          <div class="d-flex gap-2 flex-wrap mb-2">
            <button type="submit" class="btn btn-primary btn-sm">üíæ Lagre manuelt</button>
            <a href="/admin/calibrate/auto/{{ port }}" class="btn btn-outline-primary btn-sm">‚öôÔ∏è M√•l √•pnetid</a>
            <a href="/admin/calibrate/close/{{ port }}" class="btn btn-outline-secondary btn-sm">‚öôÔ∏è M√•l lukketid</a>
          </div>

          {% if cal.timestamp or cal.source %}
          <p class="text-muted small mt-2 mb-0">
            Sist oppdatert: {{ cal.timestamp or "‚Äì" }}<br>
            Kilde: {{ cal.source or "ukjent" }}
          </p>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<a href="/admin/settings" class="btn btn-secondary btn-sm mt-4">‚öôÔ∏è Tilbake til systeminnstillinger</a>
{% endblock %}

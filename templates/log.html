{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Loggvisning</h2>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <label for="logSelect" class="form-label">Velg loggfil:</label>
      <select class="form-select" id="logSelect" onchange="updateLog()">
        <option value="activity">Aktivitet</option>
        <option value="status">Statusendringer</option>
        <option value="errors">Feil</option>
        <option value="timing">Tid</option>
      </select>
    </div>
    <button class="btn btn-outline-secondary" onclick="downloadCSV()">Last ned CSV</button>
  </div>

  <table class="table table-striped sortable" id="logTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Tid ⬍</th>
        <th onclick="sortTable(1)">Innhold ⬍</th>
      </tr>
    </thead>
    <tbody id="logBody">
      <tr><td colspan="2">Laster logg...</td></tr>
    </tbody>
  </table>
</div>

<!-- Toast-container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="logToast" class="toast align-items-center text-white bg-primary border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Logg oppdatert</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="hideToast()"></button>
    </div>
  </div>
</div>

<script>
let currentLogData = [];

function showToast(message, color = 'bg-primary') {
  const toast = document.getElementById("logToast");
  const body = document.getElementById("toastBody");
  body.textContent = message;
  toast.className = `toast align-items-center text-white ${color} border-0`;
  new bootstrap.Toast(toast).show();
}

function hideToast() {
  const toast = bootstrap.Toast.getInstance(document.getElementById("logToast"));
  toast.hide();
}

function updateLog() {
  const type = document.getElementById("logSelect").value;
  fetch(`/api/logs/${type}`)
    .then(res => res.json())
    .then(data => {
      const body = document.getElementById("logBody");
      body.innerHTML = "";
      currentLogData = [];

      if (data.lines) {
        data.lines.reverse().forEach(line => {
          const [timestamp, ...msgParts] = line.split(" | ");
          const row = `<tr><td>${timestamp}</td><td>${msgParts.join(" | ")}</td></tr>`;
          body.innerHTML += row;
          currentLogData.push([timestamp, msgParts.join(" | ")]);
        });
        showToast(`Lastet ${data.lines.length} linjer`, 'bg-success');
      } else {
        body.innerHTML = `<tr><td colspan="2">Ingen data tilgjengelig</td></tr>`;
        showToast("Feil ved henting av logg", 'bg-danger');
      }
    });
}

function downloadCSV() {
  let csv = "Tid,Innhold\n";
  currentLogData.forEach(row => {
    csv += `"${row[0]}","${row[1]}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', `${document.getElementById("logSelect").value}_log.csv`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function sortTable(colIndex) {
  const rows = Array.from(document.querySelectorAll("#logBody tr"));
  const sorted = rows.sort((a, b) => {
    const textA = a.children[colIndex].innerText;
    const textB = b.children[colIndex].innerText;
    return textA.localeCompare(textB);
  });
  document.getElementById("logBody").innerHTML = "";
  sorted.forEach(row => document.getElementById("logBody").appendChild(row));
}

setInterval(updateLog, 5000);
window.addEventListener('DOMContentLoaded', updateLog);
</script>
{% endblock %}
